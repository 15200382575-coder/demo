<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>3D Nano Trap Effect Simulation</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Segoe UI', sans-serif; }
        canvas { display: block; }
        
        /* UI æ‚¬æµ®é¢æ¿ */
        #ui-container {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            pointer-events: none; /* è®©é¼ æ ‡ç©¿é€UIï¼Œä¸å½±å“æ‹–åŠ¨ */
            user-select: none;
            max-width: 350px;
        }

        h1 { margin: 0 0 10px 0; font-size: 20px; color: #00f2fe; text-shadow: 0 0 10px rgba(0, 242, 254, 0.5); }
        p { font-size: 13px; line-height: 1.5; color: #ccc; margin-bottom: 15px; }

        /* äº¤äº’æŒ‰é’®åŒºåŸŸ */
        #controls {
            pointer-events: auto; /* æŒ‰é’®éœ€è¦å“åº”ç‚¹å‡» */
            display: flex;
            gap: 10px;
        }

        button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .btn-pure {
            background: #ff4d4d;
            color: white;
            box-shadow: 0 0 10px rgba(255, 77, 77, 0.4);
        }
        .btn-pure:hover { background: #ff6666; }

        .btn-nano {
            background: #00e676;
            color: #003300;
            box-shadow: 0 0 10px rgba(0, 230, 118, 0.4);
        }
        .btn-nano:hover { background: #66ffa6; }

        .active-mode {
            outline: 2px solid white;
            transform: scale(1.05);
        }

        /* æ“ä½œæç¤º */
        #hint {
            position: absolute;
            bottom: 20px;
            width: 100%;
            text-align: center;
            color: rgba(255, 255, 255, 0.5);
            font-size: 12px;
            pointer-events: none;
        }
    </style>
    
    <!-- å¼•å…¥ Three.js æ ¸å¿ƒåº“å’Œæ§åˆ¶å™¨ -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <div id="ui-container">
        <h1 id="status-title">å½“å‰çŠ¶æ€ï¼šçº¯å‡€ XLPE</h1>
        <p id="status-desc">
            ç”µå­åœ¨ç”µåœºä½œç”¨ä¸‹æ²¿ Z è½´é«˜é€Ÿè¿åŠ¨ã€‚<br>
            <span style="color:#ff4d4d">âš ï¸ èƒ½é‡æŒç»­ç´¯ç§¯ï¼Œæ˜“å¯¼è‡´å‡»ç©¿ã€‚</span>
        </p>
        <div id="controls">
            <button class="btn-pure active-mode" onclick="setMode('pure')">çº¯å‡€æ¨¡å¼</button>
            <button class="btn-nano" onclick="setMode('nano')">çº³ç±³æºæ‚æ¨¡å¼</button>
        </div>
    </div>

    <div id="hint">ğŸ–±ï¸ å·¦é”®æ‹–åŠ¨æ—‹è½¬ Â· å³é”®å¹³ç§» Â· æ»šè½®ç¼©æ”¾</div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- 1. åœºæ™¯åˆå§‹åŒ– ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x050a14); // æ·±ç©ºè“èƒŒæ™¯
        scene.fog = new THREE.FogExp2(0x050a14, 0.002); // é›¾åŒ–æ•ˆæœï¼Œå¢åŠ æ·±é‚ƒæ„Ÿ

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 1, 1000);
        camera.position.set(0, 20, 100);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.body.appendChild(renderer.domElement);

        // --- 2. æ§åˆ¶å™¨ (é¼ æ ‡æ‹–åŠ¨) ---
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.autoRotate = true; // è‡ªåŠ¨ç¼“æ…¢æ—‹è½¬
        controls.autoRotateSpeed = 0.5;

        // --- 3. è¾…åŠ©å…ƒç´  (è¾¹æ¡†ç›’å­) ---
        const boxSize = 80;
        const geometryBox = new THREE.BoxGeometry(boxSize, boxSize, boxSize * 2);
        const edges = new THREE.EdgesGeometry(geometryBox);
        const line = new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ color: 0x1a2b4d }));
        scene.add(line);

        // --- 4. æ ¸å¿ƒå¯¹è±¡ï¼šçº³ç±³é¢—ç²’ (é™·é˜±) ---
        let traps = [];
        const trapGroup = new THREE.Group();
        scene.add(trapGroup);

        const trapGeometry = new THREE.SphereGeometry(2, 16, 16);
        const trapMaterial = new THREE.MeshBasicMaterial({ 
            color: 0xffaa00, 
            transparent: true, 
            opacity: 0.6,
            blending: THREE.AdditiveBlending // å‘å…‰å åŠ 
        });

        // é™·é˜±å…‰æ™•
        const glowMaterial = new THREE.MeshBasicMaterial({
            color: 0xff4d00,
            transparent: true,
            opacity: 0.2,
            side: THREE.BackSide
        });

        // ç”Ÿæˆéšæœºé™·é˜±
        function initTraps() {
            trapGroup.clear();
            traps = [];
            const trapCount = 20;
            
            for(let i=0; i<trapCount; i++) {
                const x = (Math.random() - 0.5) * boxSize;
                const y = (Math.random() - 0.5) * boxSize;
                const z = (Math.random() - 0.5) * boxSize * 1.8;
                
                // å®ä½“æ ¸å¿ƒ
                const mesh = new THREE.Mesh(trapGeometry, trapMaterial);
                mesh.position.set(x, y, z);
                
                // ç•Œé¢åŒºå…‰æ™• (Trap Radius)
                const glow = new THREE.Mesh(new THREE.SphereGeometry(12, 16, 16), glowMaterial);
                mesh.add(glow);

                trapGroup.add(mesh);
                traps.push({ pos: new THREE.Vector3(x, y, z), radius: 12 });
            }
            trapGroup.visible = false; // é»˜è®¤éšè—
        }
        initTraps();

        // --- 5. æ ¸å¿ƒå¯¹è±¡ï¼šç”µå­ (ç²’å­ç³»ç»Ÿ) ---
        const electronCount = 600;
        const electrons = [];
        const dummy = new THREE.Object3D(); // ç”¨äºä¸´æ—¶è®¡ç®—çŸ©é˜µ

        // ä½¿ç”¨ InstancedMesh æå‡æ€§èƒ½ (ä¸€æ¬¡æ¸²æŸ“æ‰€æœ‰ç”µå­)
        const electronGeo = new THREE.SphereGeometry(0.4, 8, 8);
        const electronMat = new THREE.MeshBasicMaterial({ color: 0x00ffff });
        const electronMesh = new THREE.InstancedMesh(electronGeo, electronMat, electronCount);
        electronMesh.instanceMatrix.setUsage(THREE.DynamicDrawUsage); // æ ‡è®°ä¸ºåŠ¨æ€
        scene.add(electronMesh);

        // åˆå§‹åŒ–ç”µå­æ•°æ®
        for(let i=0; i<electronCount; i++) {
            electrons.push({
                pos: new THREE.Vector3(
                    (Math.random() - 0.5) * boxSize,
                    (Math.random() - 0.5) * boxSize,
                    (Math.random() - 0.5) * boxSize * 2
                ),
                velocity: new THREE.Vector3(0, 0, Math.random() * 0.5 + 0.5), // åˆå§‹æ²¿Zè½´è¿åŠ¨
                trapped: false,
                color: new THREE.Color(0x00ffff)
            });
        }

        // --- 6. ç‰©ç†æ¨¡æ‹Ÿå¾ªç¯ ---
        let isDoped = false;
        
        function animate() {
            requestAnimationFrame(animate);
            controls.update(); // æ›´æ–°é¼ æ ‡äº¤äº’

            // æ›´æ–°æ¯ä¸ªç”µå­çš„çŠ¶æ€
            for(let i=0; i<electronCount; i++) {
                const e = electrons[i];

                if (isDoped) {
                    // --- æºæ‚æ¨¡å¼é€»è¾‘ ---
                    let nearestTrap = null;
                    let minDist = Infinity;

                    // å¯»æ‰¾æœ€è¿‘çš„é™·é˜±
                    for(let t of traps) {
                        const d = e.pos.distanceTo(t.pos);
                        if(d < minDist) {
                            minDist = d;
                            nearestTrap = t;
                        }
                    }

                    // å¦‚æœè¿›å…¥é™·é˜±èŒƒå›´
                    if (nearestTrap && minDist < nearestTrap.radius) {
                        // è¢«æ•è·é€»è¾‘
                        e.trapped = true;
                        
                        // 1. é€Ÿåº¦å¤§å¹…è¡°å‡ (æŸç¼š)
                        e.velocity.multiplyScalar(0.9); 
                        
                        // 2. å—åˆ°å‘å¿ƒçš„å¼•åŠ›
                        const forceDir = new THREE.Vector3().subVectors(nearestTrap.pos, e.pos).normalize();
                        e.velocity.add(forceDir.multiplyScalar(0.05));

                        // 3. é¢œè‰²å˜ä¸ºç´«è‰² (ä»£è¡¨ä½èƒ½æ€)
                        e.color.lerp(new THREE.Color(0xaa00ff), 0.1);
                    } else {
                        // å¶å°”çƒ­æ¿€å‘é€ƒé€¸
                        e.trapped = false;
                        // ä¾ç„¶æœ‰ç”µåœºåŠ›ï¼Œä½†è¾ƒå¼±
                        e.velocity.z += 0.01; 
                        e.color.lerp(new THREE.Color(0x00ffff), 0.05);
                    }

                } else {
                    // --- çº¯å‡€æ¨¡å¼é€»è¾‘ ---
                    e.trapped = false;
                    // ç”µåœºåŠ é€Ÿ (Zè½´æ–¹å‘)
                    e.velocity.z += 0.02;
                    // é¢œè‰²ä¸ºäº®é’è‰² (é«˜èƒ½æ€)
                    e.color.setHex(0x00ffff);
                }

                // é™åˆ¶æœ€å¤§é€Ÿåº¦
                const maxSpeed = isDoped ? 1.5 : 3.0;
                e.velocity.clampLength(0, maxSpeed);

                // æ›´æ–°ä½ç½®
                e.pos.add(e.velocity);

                // è¾¹ç•Œå¾ªç¯ (é£å‡ºç›’å­åå›åˆ°å¦ä¸€ç«¯)
                if(e.pos.z > boxSize) e.pos.z = -boxSize;
                if(e.pos.z < -boxSize) e.pos.z = boxSize;
                if(e.pos.x > boxSize/2) e.pos.x = -boxSize/2;
                if(e.pos.x < -boxSize/2) e.pos.x = boxSize/2;
                if(e.pos.y > boxSize/2) e.pos.y = -boxSize/2;
                if(e.pos.y < -boxSize/2) e.pos.y = boxSize/2;

                // æ›´æ–° 3D å¯¹è±¡
                dummy.position.copy(e.pos);
                dummy.updateMatrix();
                electronMesh.setMatrixAt(i, dummy.matrix);
                electronMesh.setColorAt(i, e.color);
            }

            electronMesh.instanceMatrix.needsUpdate = true;
            electronMesh.instanceColor.needsUpdate = true;

            renderer.render(scene, camera);
        }

        animate();

        // çª—å£è‡ªé€‚åº”
        window.addEventListener('resize', onWindowResize, false);
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // --- å…¨å±€äº¤äº’å‡½æ•° ---
        window.setMode = function(mode) {
            const btnPure = document.querySelector('.btn-pure');
            const btnNano = document.querySelector('.btn-nano');
            const title = document.getElementById('status-title');
            const desc = document.getElementById('status-desc');

            if (mode === 'nano') {
                isDoped = true;
                trapGroup.visible = true;
                controls.autoRotate = false; // åœæ­¢è‡ªåŠ¨æ—‹è½¬ï¼Œæ–¹ä¾¿è§‚å¯Ÿ
                
                btnNano.classList.add('active-mode');
                btnPure.classList.remove('active-mode');
                
                title.innerText = "å½“å‰çŠ¶æ€ï¼šçº³ç±³æºæ‚æ¨¡å¼";
                title.style.color = "#00e676";
                title.style.textShadow = "0 0 10px rgba(0, 230, 118, 0.5)";
                desc.innerHTML = `çº³ç±³é¢—ç²’ï¼ˆæ©™è‰²çƒä½“ï¼‰å½¢æˆ<span style="color:#00e676; font-weight:bold">æ·±é™·é˜±</span>ã€‚<br>ç”µå­è¢«æ•è·å¹¶æŸç¼šï¼ˆå˜ç´«ï¼‰ï¼Œç”µåœºç•¸å˜è¢«æŠ‘åˆ¶ã€‚`;
            } else {
                isDoped = false;
                trapGroup.visible = false;
                controls.autoRotate = true; // æ¢å¤è‡ªåŠ¨æ—‹è½¬

                btnPure.classList.add('active-mode');
                btnNano.classList.remove('active-mode');

                title.innerText = "å½“å‰çŠ¶æ€ï¼šçº¯å‡€ XLPE";
                title.style.color = "#00f2fe";
                title.style.textShadow = "0 0 10px rgba(0, 242, 254, 0.5)";
                desc.innerHTML = `ç”µå­åœ¨ç”µåœºä½œç”¨ä¸‹æ²¿ Z è½´é«˜é€Ÿè¿åŠ¨ã€‚<br><span style="color:#ff4d4d">âš ï¸ èƒ½é‡æŒç»­ç´¯ç§¯ï¼Œæ˜“å¯¼è‡´å‡»ç©¿ã€‚</span>`;
                
                // é‡ç½®ç”µå­é€Ÿåº¦æ–¹å‘
                electrons.forEach(e => {
                    e.velocity.set(0,0,Math.random() + 0.5);
                });
            }
        };
    </script>
</body>
</html>